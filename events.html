<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Buzz â€” Events</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- CORE CSS (No Tailwind) --- */
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f4f6fb;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            text-align: center;
            margin-bottom: 40px;
            letter-spacing: -1px;
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            text-decoration: none;
            color: var(--text-muted);
            border-radius: 12px;
            font-weight: 500;
            transition: 0.2s;
        }

        .nav-item:hover { background-color: #f9fafb; color: var(--text-main); }
        .nav-item.active { background-color: #eef2ff; color: var(--primary); }
        .nav-item i { width: 20px; height: 20px; }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .avatar {
            width: 40px;
            height: 40px;
            background: #eef2ff;
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* --- MAIN CONTENT --- */
        .main {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 30px;
        }

        h1 { margin: 0; font-size: 32px; }
        .subtitle { margin: 5px 0 0; color: var(--text-muted); }

        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: 0.2s;
            font-size: 14px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        
        .btn-ghost { background: transparent; color: var(--text-muted); }
        .btn-ghost:hover { background: #f3f4f6; color: var(--text-main); }

        .btn-delete {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }
        .btn-delete:hover { background: #dc2626; }

        /* --- EVENTS GRID --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .card {
            background: var(--surface);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(0,0,0,0.1);
        }

        .card-image-wrap {
            height: 180px;
            background: #e5e7eb;
            position: relative;
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .category-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.95);
            color: var(--primary);
            font-size: 11px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .card-date {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }

        .card-title {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            line-height: 1.3;
        }

        .card-desc {
            font-size: 14px;
            color: var(--text-muted);
            margin: 0 0 20px 0;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex: 1;
        }

        .card-footer {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #f3f4f6;
            padding-top: 16px;
        }

        .countdown {
            font-size: 11px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 12px;
        }
        .count-green { background: #dcfce7; color: #166534; }
        .count-red { background: #fee2e2; color: #991b1b; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-box {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
        }

        .modal-header h3 { margin: 0; font-size: 18px; }

        .modal-body { padding: 24px; }

        .form-group { margin-bottom: 16px; }
        .form-row { display: flex; gap: 16px; }
        .form-col { flex: 1; }

        label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--primary);
            border-color: var(--primary);
        }

        .helper-text { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

        .hidden { display: none !important; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar { display: none; } /* Simplified for Vanilla CSS request */
            .main { padding: 20px; }
            .header-row { flex-direction: column; align-items: flex-start; gap: 15px; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo">VEDDIT</div>
        <nav class="nav-links">
            <a href="index.html" class="nav-item"><i data-lucide="home"></i> Home</a>
            <a href="veddit.html" class="nav-item"><i data-lucide="message-circle"></i> Forum</a>
            <a href="calendram.html" class="nav-item"><i data-lucide="calendram"></i> Calendar</a>
            <a href="#" class="nav-item active"><i data-lucide="ticket"></i> Campus Buzz</a>
        </nav>
        <div class="user-profile">
            <div class="avatar" id="user-avatar">G</div>
            <div>
                <div style="font-weight:bold; font-size:14px;" id="user-name">Guest User</div>
                <div style="font-size:12px; color:var(--text-muted);" id="user-role">Viewer</div>
            </div>
        </div>
    </aside>

    <div class="main">
        
        <div class="header-row">
            <div>
                <h1>Campus Buzz</h1>
                <p class="subtitle">Upcoming workshops, fests, and competitions.</p>
            </div>
            
            <button id="add-event-btn" class="btn btn-primary hidden" onclick="openModal()">
                <i data-lucide="plus"></i> Add Event
            </button>
        </div>

        <div id="events-grid" class="grid">
            <div style="grid-column: 1/-1; text-align:center; color:#999; padding: 40px;">
                Loading events...
            </div>
        </div>

    </div>

    <div id="event-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Publish New Event</h3>
                <button class="btn-ghost" onclick="closeModal()" style="padding:4px;"><i data-lucide="x"></i></button>
            </div>
            <form class="modal-body" onsubmit="handlePublish(event)">
                
                <div class="form-group">
                    <label>Event Name</label>
                    <input type="text" id="e-name" required placeholder="e.g. Annual Tech Fest">
                </div>

                <div class="form-row">
                    <div class="form-col form-group">
                        <label>Category</label>
                        <select id="e-type">
                            <option>Tech</option>
                            <option>Cultural</option>
                            <option>Sports</option>
                            <option>Workshop</option>
                        </select>
                    </div>
                    <div class="form-col form-group">
                        <label>Date</label>
                        <input type="date" id="e-date" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col form-group">
                        <label>Time</label>
                        <input type="time" id="e-time">
                    </div>
                    <div class="form-col" style="display:flex; align-items:center; padding-top:20px;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; text-transform:none; color:var(--text-main);">
                            <input type="checkbox" id="e-countdown" checked style="width:auto;"> Show Countdown
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Registration Link (Google Form)</label>
                    <input type="url" id="e-link" required placeholder="https://forms.google.com/...">
                    <div class="helper-text">Students will be redirected here.</div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="e-desc" rows="3" placeholder="Short details about the event..."></textarea>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                    <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                    <button type="submit" id="submit-btn" class="btn btn-primary">Publish Event</button>
                </div>

            </form>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- 2. AUTH & STATE ---
        let currentUser = null;
        let userRole = 'guest'; // Default to guest, NOT redirecting

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // If logged in, fetch details
                const doc = await db.collection('users').doc(user.uid).get();
                userRole = doc.exists ? doc.data().role : 'student';
                currentUser = user;
                
                document.getElementById('user-name').innerText = doc.exists ? doc.data().username : 'User';
                document.getElementById('user-role').innerText = userRole;
                document.getElementById('user-avatar').innerText = (doc.exists ? doc.data().username : 'U').charAt(0).toUpperCase();

                // Show Operator Tools
                if (userRole === 'operator') {
                    document.getElementById('add-event-btn').classList.remove('hidden');
                }
            } else {
                // If NOT logged in (Guest Mode)
                console.log("Guest User - No Redirect");
                document.getElementById('user-name').innerText = "Guest Visitor";
                document.getElementById('user-role').innerText = "Read Only";
            }
            // Load Data regardless of auth state
            startListener();
        });

        // --- 3. DATA LISTENER ---
        function startListener() {
            const today = new Date().toISOString().substring(0, 10);
            
            // Fetch events from today onwards
            db.collection('global_events')
              .where('date', '>=', today)
              .orderBy('date', 'asc')
              .onSnapshot(snap => {
                  renderEvents(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
              });
        }

        // --- 4. RENDER LOGIC ---
        function renderEvents(events) {
            const grid = document.getElementById('events-grid');
            grid.innerHTML = '';

            if (events.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#999; padding:60px;">
                    <i data-lucide="calendar-off" style="width:48px; height:48px; margin-bottom:10px;"></i>
                    <p>No upcoming events found.</p>
                </div>`;
                lucide.createIcons();
                return;
            }

            events.forEach(e => {
                const dateObj = new Date(e.date);
                const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                // Countdown Logic
                const diff = Math.ceil((dateObj - new Date()) / (1000 * 60 * 60 * 24));
                let badge = '';
                if(e.showCountdown && diff >= 0) {
                    const colorClass = diff <= 2 ? 'count-red' : 'count-green';
                    badge = `<span class="countdown ${colorClass}">${diff} days left</span>`;
                }

                // Operator Delete Button
                const deleteBtn = userRole === 'operator' 
                    ? `<button class="btn-delete" onclick="deleteEvent('${e.id}')"><i data-lucide="trash-2" style="width:16px;"></i></button>`
                    : '';

                // Random gradient for image placeholder since we removed Image URL input
                const gradients = [
                    'linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%)',
                    'linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%)',
                    'linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)',
                    'linear-gradient(120deg, #fccb90 0%, #d57eeb 100%)'
                ];
                const randomBg = gradients[Math.floor(Math.random() * gradients.length)];

                const card = document.createElement('div');
                card.className = "card";
                
                card.innerHTML = `
                    <div class="card-image-wrap" style="background: ${randomBg}; display:flex; align-items:center; justify-content:center;">
                        <span style="font-size:40px; opacity:0.3;">ðŸ“…</span>
                        <div class="category-badge">${e.eventType}</div>
                        ${deleteBtn}
                    </div>
                    
                    <div class="card-body">
                        <div class="card-date">
                            <i data-lucide="calendar" style="width:14px;"></i> ${dateStr}
                            <span style="margin-left:auto;">${e.time || ''}</span>
                        </div>
                        
                        <h3 class="card-title">${e.name}</h3>
                        <p class="card-desc">${e.description || 'No description provided.'}</p>
                        
                        <div class="card-footer">
                            ${badge}
                            <a href="${e.registrationLink}" target="_blank" class="btn btn-primary">
                                Register <i data-lucide="arrow-right" style="width:16px;"></i>
                            </a>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        // --- 5. OPERATOR FUNCTIONS ---
        async function handlePublish(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.innerText = "Saving...";
            btn.disabled = true;

            try {
                await db.collection('global_events').add({
                    name: document.getElementById('e-name').value,
                    eventType: document.getElementById('e-type').value,
                    date: document.getElementById('e-date').value,
                    time: document.getElementById('e-time').value,
                    registrationLink: document.getElementById('e-link').value,
                    description: document.getElementById('e-desc').value,
                    showCountdown: document.getElementById('e-countdown').checked,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                closeModal();
                e.target.reset();
            } catch(err) {
                alert("Error: " + err.message);
            } finally {
                btn.innerText = "Publish Event";
                btn.disabled = false;
            }
        }

        async function deleteEvent(id) {
            if(confirm("Delete this event?")) {
                await db.collection('global_events').doc(id).delete();
            }
        }

        // --- 6. UTILS ---
        function openModal() { document.getElementById('event-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('event-modal').style.display = 'none'; }

        // Initial Icons
        lucide.createIcons();
    </script>
</body>
</html>